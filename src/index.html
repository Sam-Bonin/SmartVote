<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liberal Party Platform Explorer</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <style>
        :root {
            /* Liberal Party Brand Colors */
            --primary: #E62836; /* Liberal red */
            --primary-light: #ff5f52;
            --primary-dark: #ab000d;
            --secondary: #1E4B9A; /* Liberal blue */
            --secondary-light: #5276cc;
            --secondary-dark: #00246b;
            --background: #f9f9f9;
            --card-bg: #ffffff;
            --text: #212121;
            --text-light: #666;
            --border: #e0e0e0;
            --shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            --radius: 8px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Source Sans Pro', sans-serif;
            background-color: var(--background);
            color: var(--text);
            line-height: 1.5;
            margin: 0;
            overflow-x: hidden;
        }
        
        /* App Container */
        .app-container {
            display: flex;
            height: 100vh;
            width: 100%;
        }
        
        /* Top App Bar */
        .app-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 64px;
            background-color: var(--card-bg);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            padding: 0 16px;
            z-index: 1200;
        }
        
        .menu-button {
            display: none;
            margin-right: 16px;
            cursor: pointer;
            background: none;
            border: none;
            color: var(--primary);
        }
        
        .app-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary);
            display: flex;
            align-items: center;
            white-space: nowrap;
        }
        
        .maple-leaf {
            font-size: 24px;
            margin-right: 8px;
        }
        
        .search-container {
            flex-grow: 1;
            max-width: 600px;
            margin: 0 auto;
            position: relative;
        }
        
        .search-box {
            display: flex;
            align-items: center;
            width: 100%;
            position: relative;
        }
        
        #search-input {
            width: 100%;
            padding: 10px 16px 10px 48px;
            border: 1px solid var(--border);
            border-radius: 24px;
            background-color: #f5f5f5;
            font-size: 16px;
            color: var(--text);
            transition: all 0.3s ease;
        }
        
        #search-input:focus {
            background-color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            outline: none;
            border-color: var(--primary-light);
        }
        
        .search-icon {
            position: absolute;
            left: 16px;
            color: var(--primary);
            font-size: 22px;
        }
        
        .search-button {
            position: absolute;
            right: 8px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 24px;
            padding: 8px 16px;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .search-button:hover {
            background-color: var(--primary-dark);
        }
        
        /* Sidebar */
        .sidebar {
            width: 280px;
            background-color: var(--card-bg);
            border-right: 1px solid var(--border);
            height: 100%;
            position: fixed;
            top: 64px;
            left: 0;
            overflow-y: auto;
            z-index: 1100;
            transition: transform 0.3s ease;
        }
        
        .sidebar-title {
            padding: 24px 16px 16px;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text);
            text-align: center;
            border-bottom: 1px solid var(--border);
        }
        
        .topic-list {
            list-style: none;
            padding: 16px 0;
        }
        
        .topic-item {
            padding: 12px 24px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .topic-item:hover {
            background-color: #f5f5f5;
        }
        
        .topic-item.active {
            background-color: #f0f0f0;
            border-left: 4px solid var(--primary);
        }
        
        .topic-icon {
            color: var(--primary);
            margin-right: 16px;
            font-size: 20px;
        }
        
        .topic-text {
            font-size: 16px;
            color: var(--text);
        }
        
        /* Main Content */
        .main-content {
            flex-grow: 1;
            margin-left: 280px;
            margin-top: 64px;
            padding: 24px;
            height: calc(100vh - 64px);
            overflow-y: auto;
            transition: margin 0.3s ease;
        }
        
        .query-display {
            font-size: 24px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 24px;
            padding-bottom: 8px;
            display: inline-block;
            border-bottom: 3px solid var(--primary);
        }
        
        .card {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            padding: 24px;
            margin-bottom: 24px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .card-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
        }
        
        .card-title-icon {
            color: var(--primary);
            margin-right: 12px;
            font-size: 24px;
        }
        
        .analysis-content {
            line-height: 1.6;
            color: var(--text);
        }
        
        .analysis-content p {
            margin-bottom: 16px;
        }
        
        .analysis-content strong {
            color: var(--primary);
            font-weight: 600;
        }
        
        /* PDF Viewer */
        .pdf-viewer-card {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            margin-bottom: 24px;
            overflow: hidden;
        }
        
        .pdf-header {
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
        }
        
        .pdf-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
            display: flex;
            align-items: center;
        }
        
        .pdf-title-icon {
            color: var(--primary);
            margin-right: 12px;
        }
        
        .expand-icon {
            transition: transform 0.3s ease;
        }
        
        .expanded .expand-icon {
            transform: rotate(180deg);
        }
        
        .pdf-viewer-container {
            height: 0;
            overflow: hidden;
            transition: height 0.3s ease;
        }
        
        .pdf-viewer-container.expanded {
            height: 600px;
        }
        
        .pdf-frame {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        /* Supporting Evidence */
        .evidence-section {
            margin-top: 32px;
        }
        
        .evidence-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
        }
        
        .evidence-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }
        
        .evidence-card {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            padding: 16px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .evidence-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .evidence-meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .similarity-badge {
            color: var(--primary);
            font-weight: 600;
        }
        
        .page-number {
            color: var(--text-light);
        }
        
        .evidence-text {
            font-size: 15px;
            line-height: 1.5;
        }
        
        /* Loading animation */
        .loading-dots {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }
        
        .loading-dots span {
            width: 12px;
            height: 12px;
            margin: 0 5px;
            background-color: var(--primary);
            border-radius: 50%;
            display: inline-block;
            animation: bounce 1.5s infinite ease-in-out both;
        }
        
        .loading-dots span:nth-child(1) {
            animation-delay: -0.3s;
        }
        
        .loading-dots span:nth-child(2) {
            animation-delay: -0.15s;
        }
        
        @keyframes bounce {
            0%, 80%, 100% { 
                transform: scale(0);
                opacity: 0.5;
            }
            40% { 
                transform: scale(1);
                opacity: 1;
            }
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.5s ease forwards;
        }
        
        .animate-fade-in-delay-1 {
            opacity: 0;
            animation: fadeIn 0.5s ease forwards 0.1s;
        }
        
        .animate-fade-in-delay-2 {
            opacity: 0;
            animation: fadeIn 0.5s ease forwards 0.2s;
        }
        
        .animate-fade-in-delay-3 {
            opacity: 0;
            animation: fadeIn 0.5s ease forwards 0.3s;
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .main-content {
                margin-left: 280px;
            }
            
            .evidence-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .menu-button {
                display: block;
            }
            
            .app-title {
                font-size: 1.1rem;
            }
            
            .evidence-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 576px) {
            .app-bar {
                padding: 0 12px;
            }
            
            .app-title {
                display: none;
            }
            
            .search-container {
                margin-left: 0;
            }
            
            .main-content {
                padding: 16px;
            }
            
            .pdf-viewer-container.expanded {
                height: 400px;
            }
        }
        
        /* Utility classes */
        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Top App Bar -->
        <div class="app-bar">
            <button id="menuToggle" class="menu-button">
                <span class="material-icons">menu</span>
            </button>
            <div class="app-title">
                <span class="maple-leaf">🍁</span>
                Liberal Party Platform Explorer
            </div>
            <div class="search-container">
                <div class="search-box">
                    <span class="material-icons search-icon">search</span>
                    <input type="text" id="search-input" placeholder="Ask a question about Liberal Party policies..." />
                    <button id="search-button" class="search-button">Search</button>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div id="sidebar" class="sidebar">
            <div class="sidebar-title">Popular Topics</div>
            <ul class="topic-list">
                <li class="topic-item active" data-query="What is the policy on healthcare?">
                    <span class="material-icons topic-icon">local_hospital</span>
                    <span class="topic-text">Healthcare Policy</span>
                </li>
                <li class="topic-item" data-query="How does the party plan to address climate change?">
                    <span class="material-icons topic-icon">wb_sunny</span>
                    <span class="topic-text">Climate Change</span>
                </li>
                <li class="topic-item" data-query="What are the plans for affordable housing?">
                    <span class="material-icons topic-icon">home</span>
                    <span class="topic-text">Affordable Housing</span>
                </li>
                <li class="topic-item" data-query="How will education funding be improved?">
                    <span class="material-icons topic-icon">school</span>
                    <span class="topic-text">Education Funding</span>
                </li>
                <li class="topic-item" data-query="What is the stance on job creation?">
                    <span class="material-icons topic-icon">work</span>
                    <span class="topic-text">Job Creation</span>
                </li>
                <li class="topic-item" data-query="What are the party's tax policies?">
                    <span class="material-icons topic-icon">account_balance</span>
                    <span class="topic-text">Tax Policies</span>
                </li>
                <li class="topic-item" data-query="How does the party support small businesses?">
                    <span class="material-icons topic-icon">business</span>
                    <span class="topic-text">Small Business Support</span>
                </li>
            </ul>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Results Container -->
            <div id="results">
                <!-- Query Display -->
                <h1 id="queryDisplay" class="query-display animate-fade-in"></h1>
                
                <!-- Policy Analysis Card -->
                <div class="card animate-fade-in-delay-1">
                    <h2 class="card-title">
                        <span class="material-icons card-title-icon">analytics</span>
                        Policy Analysis
                    </h2>
                    <div id="analysis" class="analysis-content"></div>
                </div>
                
                <!-- PDF Viewer Card -->
                <div id="pdfViewerCard" class="pdf-viewer-card animate-fade-in-delay-2">
                    <div id="pdfHeader" class="pdf-header">
                        <h2 class="pdf-title">
                            <span class="material-icons pdf-title-icon">description</span>
                            <span id="pdfTitleText">Most Relevant Page</span>
                        </h2>
                        <span class="material-icons expand-icon">expand_more</span>
                    </div>
                    <div id="pdfViewerContainer" class="pdf-viewer-container">
                        <iframe id="pdfViewer" class="pdf-frame" src="" title="Liberal Party Platform PDF"></iframe>
                    </div>
                </div>
                
                <!-- Supporting Evidence Section -->
                <div class="evidence-section animate-fade-in-delay-3">
                    <h2 class="evidence-title">Supporting Evidence</h2>
                    <div id="documents" class="evidence-grid"></div>
                    <button id="viewMoreBtn" class="search-button hidden" style="margin-top: 16px;">View More Results</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Hidden reference element for PDF URLs -->
    <a id="relevantPageLink" href="" class="hidden"></a>

    <script>
        // DOM Elements
        const sidebar = document.getElementById('sidebar');
        const menuToggle = document.getElementById('menuToggle');
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const resultsContainer = document.getElementById('results');
        const queryDisplay = document.getElementById('queryDisplay');
        const pdfHeader = document.getElementById('pdfHeader');
        const pdfViewerContainer = document.getElementById('pdfViewerContainer');
        const pdfViewer = document.getElementById('pdfViewer');
        const pdfTitleText = document.getElementById('pdfTitleText');
        const topicItems = document.querySelectorAll('.topic-item');
        const viewMoreBtn = document.getElementById('viewMoreBtn');
        
        // Initial state
        resultsContainer.classList.add('hidden');
        let currentPage = 1;
        window.relevantPage = 1;
        
        // Toggle sidebar on mobile
        menuToggle.addEventListener('click', function() {
            sidebar.classList.toggle('open');
        });
        
        // Set active topic item
        function setActiveTopic(element) {
            topicItems.forEach(item => item.classList.remove('active'));
            if (element) element.classList.add('active');
        }
        
        // Handle topic clicks
        topicItems.forEach(item => {
            item.addEventListener('click', function() {
                setActiveTopic(this);
                const query = this.getAttribute('data-query');
                searchInput.value = query;
                submitQuery();
                
                // Close sidebar on mobile
                if (window.innerWidth <= 768) {
                    sidebar.classList.remove('open');
                }
            });
        });
        
        // Toggle PDF viewer and load PDF
        pdfHeader.addEventListener('click', function() {
            pdfViewerContainer.classList.toggle('expanded');
            pdfHeader.parentElement.classList.toggle('expanded');
            
            // Set PDF source if expanding the viewer
            if (pdfViewerContainer.classList.contains('expanded')) {
                loadPDF(window.relevantPage);
            }
        });
        
        // Function to handle PDF loading with error protection
        function loadPDF(pageNum) {
            try {
                // Default to page 1 if not provided
                const page = pageNum || 1;
                
                // Construct the URL
                const pdfUrl = `/data/Liberal.pdf#page=${page}`;
                
                // Set the source
                console.log("Loading PDF at page:", page);
                pdfViewer.src = pdfUrl;
                
                // Update relevant page reference
                window.relevantPage = page;
                
                // Update title
                pdfTitleText.textContent = `PDF Page ${page}`;
                
                return true;
            } catch (error) {
                console.error("Error loading PDF:", error);
                pdfTitleText.textContent = "PDF Viewer (Error loading)";
                return false;
            }
        }
        
        // Set query from topic chip
        function setQuery(text) {
            searchInput.value = text;
            submitQuery();
            
            // Set active topic
            topicItems.forEach(item => {
                if (item.getAttribute('data-query') === text) {
                    setActiveTopic(item);
                }
            });
        }
        
        // Submit query function
        async function submitQuery() {
            const query = searchInput.value;
            if (!query.trim()) return;
            
            // Show loading state
            resultsContainer.classList.remove('hidden');
            queryDisplay.textContent = `"${query}"`;
            
            const analysisContainer = document.getElementById('analysis');
            analysisContainer.innerHTML = '<div class="loading-dots"><span></span><span></span><span></span></div>';
            
            document.getElementById('documents').innerHTML = '';
            viewMoreBtn.classList.add('hidden');
            
            try {
                console.log("Submitting query:", query);
                
                // Use streaming endpoint
                const response = await fetch('/query-stream', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ text: query }),
                    cache: 'no-store',
                    credentials: 'same-origin',
                    mode: 'cors',
                    redirect: 'follow',
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("API Error:", errorText);
                    throw new Error(`Network response was not ok: ${response.status} ${response.statusText}`);
                }
                
                // Set up reader for streaming response
                const reader = response.body.getReader();
                const decoder = new TextDecoder('utf-8');
                let buffer = '';
                
                // Process the stream
                while (true) {
                    const { done, value } = await reader.read();
                    
                    if (done) {
                        break;
                    }
                    
                    // Decode and process the chunk
                    buffer += decoder.decode(value, { stream: true });
                    
                    // Process complete lines
                    const lines = buffer.split('\n');
                    buffer = lines.pop(); // Keep the last incomplete line in the buffer
                    
                    for (const line of lines) {
                        if (line.trim() === '') continue;
                        
                        try {
                            const data = JSON.parse(line);
                            console.log("Received streaming data:", data);
                            
                            // Handle different response types
                            if (data.status === 'partial' && data.step === 'documents_ready') {
                                // Display documents as they arrive
                                updateDocuments(data.similar_documents);
                            } else if (data.status === 'complete') {
                                // Display analysis when it arrives
                                updateAnalysis(data.analysis, query);
                            } else if (data.status === 'processing') {
                                // Update loading message
                                updateLoadingState(data.step);
                            } else if (data.status === 'error') {
                                throw new Error(data.message);
                            }
                        } catch (error) {
                            console.error("Error parsing streaming data:", error);
                        }
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                analysisContainer.innerHTML = `
                    <p style="color: #E62836; font-weight: bold;">Error: ${error.message}</p>
                    <p>Please make sure the server is running and the embeddings file exists.</p>
                `;
            }
        }
        
        // Update loading state based on current step
        function updateLoadingState(step) {
            const analysisContainer = document.getElementById('analysis');
            if (step === 'retrieval') {
                analysisContainer.innerHTML = '<div class="loading-dots"><span></span><span></span><span></span></div><p>Retrieving documents...</p>';
            } else if (step === 'analysis') {
                analysisContainer.innerHTML = '<div class="loading-dots"><span></span><span></span><span></span></div><p>Generating analysis...</p>';
            }
        }
        
        // Update documents display
        function updateDocuments(documents) {
            const documentsContainer = document.getElementById('documents');
            documentsContainer.innerHTML = '';
            
            // Store all documents for view more functionality
            window.allDocuments = documents;
            const initialDisplay = Math.min(5, documents.length);
            
            // Display first 5 documents
            for(let i = 0; i < initialDisplay; i++) {
                const doc = documents[i];
                documentsContainer.appendChild(createEvidenceCard(doc, i));
            }
            
            // Show/hide view more button
            if (documents.length > 5) {
                viewMoreBtn.classList.remove('hidden');
                viewMoreBtn.textContent = `View ${documents.length - 5} More Results`;
            } else {
                viewMoreBtn.classList.add('hidden');
            }
            
            // Update PDF viewer
            if (documents.length > 0) {
                try {
                    const topDoc = documents[0];
                    
                    // Ensure page property exists
                    let topPage = 1; // Default to page 1
                    if (typeof topDoc.page !== 'undefined') {
                        topPage = topDoc.page;
                    } else if (typeof topDoc.page_num !== 'undefined') {
                        topPage = topDoc.page_num;
                        console.log("Using page_num instead of page:", topPage);
                    }
                    
                    // Update the title text without updating the PDF source yet
                    pdfTitleText.textContent = `Most Relevant Page (PDF Page ${topPage})`;
                    
                    // Update the link for the iframe
                    const relevantPageLink = document.getElementById('relevantPageLink');
                    relevantPageLink.href = `/data/Liberal.pdf#page=${topPage}`;
                    
                    // Store the page reference globally
                    window.relevantPage = topPage;
                    
                    // If PDF viewer is already expanded, update the source using our safe function
                    if (pdfViewerContainer.classList.contains('expanded')) {
                        loadPDF(topPage);
                    }
                } catch (error) {
                    console.error("Error updating PDF viewer:", error);
                    pdfTitleText.textContent = "PDF Viewer (Error loading page)";
                }
            }
        }
        
        // Update analysis display
        function updateAnalysis(analysis, query) {
            // Update query display
            queryDisplay.textContent = `"${query}"`;
            
            // Get the analysis container
            const analysisContainer = document.getElementById('analysis');
            
            // First process the raw text to prevent HTML tag splitting
            const rawText = analysis.response;
            
            // Process the text all at once before displaying
            let processedHtml = rawText
                // Bold text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // Italic text
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // Headers
                .replace(/^### (.*?)$/gm, '<h3>$1</h3>')
                .replace(/^## (.*?)$/gm, '<h2>$1</h2>')
                .replace(/^# (.*?)$/gm, '<h1>$1</h1>');
            
            // Process lists after other formatting
            let lines = processedHtml.split('\n');
            let inList = false;
            let listType = '';
            
            for (let i = 0; i < lines.length; i++) {
                // Check for bullet list items
                if (lines[i].match(/^- (.*?)$/)) {
                    if (!inList || listType !== 'ul') {
                        // Start a new list if not in one
                        lines[i] = inList ? '</'+listType+'><ul><li>' + lines[i].substring(2) + '</li>' : '<ul><li>' + lines[i].substring(2) + '</li>';
                        inList = true;
                        listType = 'ul';
                    } else {
                        // Continue the list
                        lines[i] = '<li>' + lines[i].substring(2) + '</li>';
                    }
                }
                // Check for numbered list items
                else if (lines[i].match(/^\d+\. (.*?)$/)) {
                    if (!inList || listType !== 'ol') {
                        // Start a new list if not in one
                        lines[i] = inList ? '</'+listType+'><ol><li>' + lines[i].replace(/^\d+\. /, '') + '</li>' : '<ol><li>' + lines[i].replace(/^\d+\. /, '') + '</li>';
                        inList = true;
                        listType = 'ol';
                    } else {
                        // Continue the list
                        lines[i] = '<li>' + lines[i].replace(/^\d+\. /, '') + '</li>';
                    }
                }
                // Not a list item - close list if we were in one
                else if (inList && lines[i].trim() !== '') {
                    lines[i] = '</'+listType+'>' + lines[i];
                    inList = false;
                }
            }
            
            // Close any open list at the end
            if (inList) {
                lines.push('</'+listType+'>');
            }
            
            // Reassemble the lines
            processedHtml = lines.join('\n');
            
            // Handle paragraphs - split by double newlines
            const paragraphs = processedHtml.split('\n\n');
            processedHtml = paragraphs.map(p => {
                // Skip if already wrapped in a block element
                if (p.trim().startsWith('<h') || p.trim().startsWith('<ul') || 
                    p.trim().startsWith('<ol') || p.trim().startsWith('<p')) {
                    return p;
                }
                // Otherwise wrap in paragraph tags
                return '<p>' + p + '</p>';
            }).join('\n');
            
            // Replace single newlines with <br> only within paragraphs
            processedHtml = processedHtml.replace(/<p>(.*?)<\/p>/gs, function(match, p1) {
                return '<p>' + p1.replace(/\n/g, '<br>') + '</p>';
            });
            
            // Display the fully processed HTML at once
            analysisContainer.innerHTML = processedHtml;
            
            // Add a fade-in animation instead of typing effect
            analysisContainer.style.opacity = '0';
            setTimeout(() => {
                analysisContainer.style.transition = 'opacity 0.5s ease-in-out';
                analysisContainer.style.opacity = '1';
            }, 50);
        }
        
        // Format the analysis with improved styling - replaced by the functions above
        function displayResults(data, query) {
            // Update analysis and documents using the new functions
            updateAnalysis(data.analysis, query);
            updateDocuments(data.similar_documents);
        }
        
        // Create evidence card element
        function createEvidenceCard(doc, index) {
            const delay = index * 100; // Staggered animation
            const card = document.createElement('div');
            card.className = `evidence-card animate-fade-in`;
            card.style.animationDelay = `${delay}ms`;
            
            // Ensure score and page properties exist with fallbacks
            let score = 0;
            if (typeof doc.score !== 'undefined') {
                score = doc.score;
            } else if (typeof doc.similarity !== 'undefined') {
                score = doc.similarity;
            }
            
            let page = 1;
            if (typeof doc.page !== 'undefined') {
                page = doc.page;
            } else if (typeof doc.page_num !== 'undefined') {
                page = doc.page_num;
            }
            
            const cardHtml = `
                <div class="evidence-meta">
                    <span class="similarity-badge">${Math.round(score * 100)}% Match</span>
                    <span class="page-number">PDF Page ${page}</span>
                </div>
                <div class="evidence-text">${doc.text || "No text available"}</div>
            `;
            
            card.innerHTML = cardHtml;
            
            // Add click event to navigate to this page in the PDF
            card.addEventListener('click', () => {
                // Ensure the PDF viewer is expanded
                if (!pdfViewerContainer.classList.contains('expanded')) {
                    pdfViewerContainer.classList.add('expanded');
                    pdfHeader.parentElement.classList.add('expanded');
                }
                
                // Load the PDF at the specific page
                loadPDF(page);
                
                // Scroll to the PDF viewer
                pdfHeader.scrollIntoView({ behavior: 'smooth' });
            });
            
            return card;
        }
        
        // View more button functionality
        viewMoreBtn.addEventListener('click', function() {
            const documentsContainer = document.getElementById('documents');
            const currentCount = documentsContainer.children.length;
            const allDocs = window.allDocuments;
            
            // Display next 5 documents
            for(let i = currentCount; i < Math.min(currentCount + 5, allDocs.length); i++) {
                documentsContainer.appendChild(createEvidenceCard(allDocs[i], i - currentCount));
            }
            
            // Update or hide button
            if (documentsContainer.children.length >= allDocs.length) {
                this.classList.add('hidden');
            } else {
                this.textContent = `View ${allDocs.length - documentsContainer.children.length} More Results`;
            }
        });
        
        // Search button click
        searchButton.addEventListener('click', submitQuery);
        
        // Allow Enter key to submit
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                submitQuery();
            }
        });
        
        // Initial load - activate first topic
        window.addEventListener('DOMContentLoaded', function() {
            // Simulate click on first topic
            if (topicItems.length > 0) {
                topicItems[0].click();
            }
        });
    </script>
</body>

</html>